use std::collections::HashMap;
use std::time::Duration;
use crossterm::{
    cursor,
    execute,
    style::Print,
    terminal::{Clear, ClearType},
};
use std::io::stdout;
use tokio::time;
use rand::Rng;

// pub : í•´ë‹¹ í•¨ìˆ˜ëŠ” pubë¡œì¨ ë‹¤ë¥¸ ëª¨ë“ˆì—ì„œ í™ì¶œì´ ê°€ëŠ¥í•¨ì„ ì˜ë¯¸
// u64ëŠ” ë¶€í˜¸ ì—†ëŠ” 64bit
pub async fn run_pomodoro_timer(work_min: u64, break_min: u64) {
  // HashMapì„ ìƒì„±í•¨.
  let ascii_map = get_ascii_art_map();

  loop {
      println!("\nğŸŸ¢ Starting 25-minute Work Session...");
      // íƒ€ì´ë¨¸ê°€ ë™ì‘í•˜ëŠ” ê³¼ì •ì—ì„œ HashMapì˜ ë°ì´í„°ë¥¼ ì°¸ì¡°í•  ìˆ˜ ìˆë„ë¡ í•¨.
      run_timer(work_min, &ascii_map, "Work").await;

      println!("\nğŸŸ¡ Starting 5-minute Break...");
      run_timer(break_min, &ascii_map, "Break").await;
  }
}

// -> ì€ ë°˜í™˜ íƒ€ì…ì„ ì§€ì •í•¨.
// & : ì°¸ì¡° (ê°’ì„ ë¹Œë ¤ì˜¨ë‹¤ëŠ” ëœ»ì„, ê°’ì„ ë³µì‚¬í•˜ê±°ë‚˜ ì†Œìœ ê¶Œì„ ì˜®ê¸°ëŠ” ê²ƒì´ ì•„ë‹Œ ì›ë³¸ ë°ì´í„°ì— ëŒ€í•œ ì ‘ê·¼ë§Œ í—ˆìš©)
// 'static : ìƒì•  ì£¼ê¸°ë¥¼ ë‚˜íƒ€ëƒ„. ë°ì´í„°ê°€ í”„ë¡œê·¸ë¨ ì „ì²´ ì‹¤í–‰ ì‹œê°„ë™ì•ˆ ìœ íš¨í•¨ì„ ì˜ë¯¸í•¨. (í•­ìƒ ë©”ëª¨ë¦¬ì— ë‚¨ì•„ ìˆìŒ.)
fn get_random_motivation() -> &'static str {
    // vec! ëŠ” ë™ì  ë°°ì—´ì„ ìƒì„±í•˜ëŠ” ë§¤í¬ë¡œì…ë‹ˆë‹¤.
    // letì€ ê¸°ë³¸ì ìœ¼ë¡œ ë¶ˆë³€ì´ê³  ì´ë¥¼ ë³€ê²½í•˜ê¸° ìœ„í•´ì„œëŠ” let mutì„ ì‚¬ìš©í•´ì•¼ í•¨.
    let messages = vec![
        "ğŸ’€ ê³µë¶€ ì•ˆ í•˜ë©´, ë„¤ ì¸ìƒì€ ì´ë¯¸ ëë‚¬ë‹¤. ì§€ê¸ˆì´ë¼ë„ ë¶™ì¡ì•„.",
        "ğŸ”¥ ë„Œ ì§€ê¸ˆ ë…¸ëŠ” ê²Œ í¸í•˜ì§€? ê·¸ ëŒ€ê°€ë¡œ í‰ìƒ ê³ í†µë°›ì„ ì¤€ë¹„ëŠ” ëëƒ?",
        "âš°ï¸ ë„¤ê°€ ê³µë¶€ë¥¼ í¬ê¸°í•˜ëŠ” ìˆœê°„, ë¯¸ë˜ì˜ ë„Œ ìˆ¨ ì‰´ ê³µê°„ì¡°ì°¨ ì—†ì„ ê±°ë‹¤.",
        "ğŸ’£ ì§€ê¸ˆ ë„Œ ë³€ëª…í•˜ê³  ìˆì§€ë§Œ, ë³€ëª…ì€ ë„¤ í†µì¥ ì”ê³ ë¥¼ ì±„ì›Œì£¼ì§€ ì•ŠëŠ”ë‹¤.",
        "âš¡ ë†€ì§€ ë§ˆë¼. ë„Œ ì´ë¯¸ ì‹¤íŒ¨ì˜ ê¸¸ì„ ê±·ê³  ìˆë‹¤. ë©ˆì¶”ê³  ê³µë¶€í•´.",
        "ğŸ‘€ ë„ˆ ì§€ê¸ˆ ë­í•˜ëƒ? ë„¤ ê²½ìŸìëŠ” ì´ë¯¸ ë„ ë°Ÿê³  ì§€ë‚˜ê°”ë‹¤.",
        "ğŸ©¸ ì‰¬ê³  ì‹¶ë‹¤ê³ ? ê·¸ëŸ¬ë©´ í‰ìƒ ê³ ìƒí•  ê°ì˜¤ë„ ê°™ì´ í•´ë¼.",
        "ğŸ’¥ ì§€ê¸ˆì˜ ê²Œìœ¼ë¦„ì€ ë„¤ ë¯¸ë˜ë¥¼ ë°•ì‚´ ë‚¸ë‹¤. ì •ì‹  ì°¨ë ¤!",
        "ğŸ”¥ ë„¤ê°€ ì›í•˜ëŠ” ê²Œ ì„±ê³µì´ë¼ë©´, ì§€ê¸ˆ ë‹¹ì¥ ê³µë¶€í•˜ëŸ¬ ê°€ë¼. ì•„ë‹ˆë©´ ê¿ˆë„ ê¾¸ì§€ ë§ˆë¼.",
        "âš¡ 'ë‚˜ì¤‘ì—'ëŠ” ì—†ë‹¤. ì§€ê¸ˆ ì•ˆ í•˜ë©´ ë„Œ ì˜ì›íˆ ëë‚œë‹¤.",
        "ğŸš€ ë„ˆ ì§€ê¸ˆ ì±… ì•ˆ íˆì§€? ê·¸ëŸ¼ ë¯¸ë˜ì— ë„Œ ë„¤ ìë¦¬ë„ ì—†ì„ ê±°ë‹¤.",
        "ğŸ‘Š ê³µë¶€ ì•ˆ í•˜ë©´, ë„¤ ë¶€ëª¨ë‹˜ ì–¼êµ´ì— ë¨¹ì¹ í•˜ëŠ” ê±°ë‹¤. ì§€ê¸ˆ í•´ë¼!",
        "ğŸ˜¡ ë…¸ë ¥ ì•ˆ í•˜ê² ë‹¤ê³ ? ê·¸ëŸ¼ í‰ìƒ ë•…ë°”ë‹¥ì—ì„œ êµ´ëŸ¬ë¼.",
        "ğŸ’¢ ì§€ê¸ˆì´ í˜ë“¤ë‹¤ê³ ? ë„¤ê°€ í¬ê¸°í•˜ë©´ í‰ìƒì´ ë” í˜ë“¤ì–´ì§ˆ ê±°ë‹¤.",
        "âš°ï¸ ë„¤ê°€ ë†€ê³  ìˆëŠ” ë™ì•ˆ, ì„±ê³µì€ ì´ë¯¸ ë„¤ ì†ì„ ë– ë‚¬ë‹¤.",
        "ğŸ’€ ë„ˆ ì§€ê¸ˆ ë©ˆì¶”ë©´, ë¯¸ë˜ì—” ì‹œì‘ì¡°ì°¨ ëª» í•  ê±°ë‹¤. ëë‚¬ë‹¤.",
        "ğŸ©¸ ê³µë¶€í•˜ê¸° ì‹«ì§€? ê·¸ë˜, ê·¸ëŸ¼ í‰ìƒ ë„¤ ê¿ˆì€ ì“°ë ˆê¸°í†µì— ì²˜ë°•í˜€ ìˆì„ ê±°ë‹¤.",
        "ğŸ”¥ ì§€ê¸ˆ ì‹œì‘í•´. ì•„ë‹ˆë©´ ì˜ì›íˆ í›„íšŒí•˜ë©° ì‚´ê²Œ ë  ê±°ë‹¤.",
        "âš¡ ë„¤ê°€ 'ë‚˜ì¤‘ì—'ë¥¼ ì™¸ì¹˜ëŠ” ìˆœê°„, ì‹¤íŒ¨ëŠ” ì´ë¯¸ ë„¤ ê³ì— ìˆë‹¤.",
        "ğŸ’€ ì‹¤íŒ¨í•  ìš©ê¸°ê°€ ìˆëƒ? ì•„ë‹ˆë©´ ì§€ê¸ˆ ê³µë¶€í•  ìš©ê¸°ë¥¼ ë‚´ë¼.",
    ];

    let mut rng = rand::thread_rng(); // ëœë¤ ìƒì„±ê¸°ë¥¼ ì´ˆê¸°í™” ì§„í–‰
    let index = rng.gen_range(0..messages.len()); // ë©”ì‹œì§€ ê¸¸ì´ ë‚´ì—ì„œ ëœë¤ ìˆ«ìë¥¼ ìƒì„±
    messages[index] // ë©”ì‹œì§€ ë°˜í™˜ (; ì—†ìœ¼ë¯€ë¡œ ê·¸ëƒ¥ ë°˜í™˜í•˜ëŠ” ê²ƒ)
}

// HashMap(key-value)ì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
// char:ëŠ” '0', '1', ..., ':' ê³¼ ê°™ì€ ë¬¸ì
// ì–´ì°¨í”¼ ì‚¬ìš©í•´ì•¼ë˜ëŠ” ë°ì´í„°ì´ë¯€ë¡œ &'static ì„ ì‚¬ìš©í•˜ì—¬ ë©”ëª¨ë¦¬ë¡œ ë¶€í„° ë°ì´í„°ë¥¼ ì°¸ì¡°í•œë‹¤ëŠ” ê²ƒì„. 
fn get_ascii_art_map() -> HashMap<char, Vec<&'static str>> {
    let mut map = HashMap::new(); // HashMapì„ ì´ˆê¸°í™”

    // HashMapì— keyì— ëŒ€ì‘í•˜ëŠ” valueë¥¼ ì‚½ì…
    map.insert('0', vec![
        "  00000  ",
        " 0     0 ",
        " 0     0 ",
        " 0     0 ",
        " 0     0 ",
        " 0     0 ",
        "  00000  ",
    ]);
    map.insert('1', vec![
        "    11   ",
        "   111   ",
        "    11   ",
        "    11   ",
        "    11   ",
        "    11   ",
        "   11111 ",
    ]);
    map.insert('2', vec![
        "  22222  ",
        " 2     2 ",
        "       2 ",
        "    222  ",
        "   2     ",
        "  2      ",
        " 2222222 ",
    ]);
    map.insert('3', vec![
        "  33333  ",
        " 3     3 ",
        "       3 ",
        "   3333  ",
        "       3 ",
        " 3     3 ",
        "  33333  ",
    ]);
    map.insert('4', vec![
        "     44  ",
        "    444  ",
        "   4 44  ",
        "  4  44  ",
        " 4444444 ",
        "     44  ",
        "     44  ",
    ]);
    map.insert('5', vec![
        "  555555 ",
        "  5      ",
        "  55555  ",
        "       5 ",
        "       5 ",
        " 5     5 ",
        "  55555  ",
    ]);
    map.insert('6', vec![
        "   6666  ",
        "  6      ",
        "  6      ",
        "  66666  ",
        "  6    6 ",
        "  6    6 ",
        "   6666  ",
    ]);
    map.insert('7', vec![
        " 7777777 ",
        "      77 ",
        "     77  ",
        "    77   ",
        "   77    ",
        "   77    ",
        "   77    ",
    ]);
    map.insert('8', vec![
        "  88888  ",
        " 8     8 ",
        " 8     8 ",
        "  88888  ",
        " 8     8 ",
        " 8     8 ",
        "  88888  ",
    ]);
    map.insert('9', vec![
        "  99999  ",
        " 9     9 ",
        " 9     9 ",
        "  999999 ",
        "       9 ",
        "      9  ",
        "  9999   ",
    ]);
    map.insert(':', vec![
        "         ",
        "    .    ",
        "         ",
        "         ",
        "         ",
        "    .    ",
        "         ",
    ]);

    map // ë°ì´í„° ì‚½ì… ì™„ë£Œ í›„ì— HashMapì„ ë°˜í™˜
}

// sesstion_typeì€ ë¬¸ìì—´ì„ ì°¸ì¡°í•˜ê³  ìˆìŒ. ë§Œì•½ ì°¸ì¡°ë¥¼ í•˜ì§€ ì•Šê³  Stringì„ í•´ë²„ë¦¬ë©´ ì†Œìœ ê¶Œì´ ì´ì „ë¨.
async fn run_timer(minutes: u64, ascii_map: &HashMap<char, Vec<&str>>, session_type: &str) {
    // let mutì€ ë³€ê²½ ê°€ëŠ¥í•œ ë³€ìˆ˜
    let mut total_seconds = minutes * 60;

    let mut current_motivation = get_random_motivation();
    let mut seconds_motivation = 0;

    while total_seconds > 0 {
        let mins = total_seconds / 60;
        let secs = total_seconds % 60;
        let time_str = format!("{:02}:{:02}", mins, secs); // 2ìë¦¬ë¡œ ìˆ«ìë¥¼ ì¶œë ¥í•˜ë„ë¡ í¬ë§·íŒ….

        let mut stdout = stdout(); // í„°ë¯¸ë„ ì¶œë ¥ ìŠ¤íŠ¸ë¦¼

        // í„°ë¯¸ë„ ì‘ì—… ì‹¤í–‰ì„ ìœ„í•œ ë§¤í¬ë¡œ (í„°ë¯¸ë„ì— ëª…ë ¹ì„ ì „ë‹¬í•˜ì—¬ íŠ¹ì • ì‘ì—…ì„ ì‹¤í–‰í•˜ëŠ” ì—­í• )
        // targetì€ í‘œì¤€ ì¶œë ¥ ì¥ì¹˜
        // ë‹¤ìŒì€ ëª…ë ¹ì–´ë¥¼ ì‘ì„± (ì»¤ì„œ ìœ„ì¹˜ë¥¼ 0,0 ì¢Œì¸¡ ìƒë‹¨ìœ¼ë¡œ ì´ë™ì‹œí‚´, ì „ì²´í™”ë©´ì„ ì§€ì›€)
        // unwrap() ì€ í•­ìƒ ì„±ê³µí•  ê²ƒì´ë¼ëŠ” ì „ì œ í•˜ì— ì‚¬ìš©. ì‹¤íŒ¨í•˜ë©´ í”„ë¡œê·¸ë¨ íŒ¨ë‹‰ -> í”„ë¡œê·¸ë¨ ê°•ì œ ì¢…ë£Œ (ë”°ë¼ì„œ ì´ê±°ë³´ë‹¤ ë‹¤ë¥¸ ë°©ë²•ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ)
        // execute!(stdout, cursor::MoveTo(0, 0), Clear(ClearType::All)).unwrap(); -> ê¸°ì¡´ ì½”ë“œë¥¼ ì•„ë˜ì™€ ê°™ì´ ì‚¬ìš©í•˜ëŠ”ê²Œ ì•ˆì „
        if let Err(error) = execute!(stdout, cursor::MoveTo(0, 0), Clear(ClearType::All)){
          eprintln!("Error Clearing the Terminal: {}", error);
        }

        // ìƒ‰ìƒì€ ì‚­ì œ í•˜ì˜€ìŒ.
        if let Err(error) = execute!(
            stdout,
            Print(format!("ğŸ”” {} Timer\n\n", session_type)),
        ) {
          eprintln!("Error Start Timer : {}", error);
        }

        if seconds_motivation >= 10 {
          current_motivation = get_random_motivation();
          seconds_motivation = 0;
        }

        println!("{}", current_motivation);
        println!("");

        // ì´ 7ì¤„ (í–‰)ì„ ìˆœíšŒí•¨.
        for row in 0..7 {
            let mut line = String::new();

            //ì‹œê°„ ë¬¸ìì—´ì„ ìˆœíšŒí•¨.
            for ch in time_str.chars() {
                // ascli_mapì—ì„œ í˜„ì¬ ë¬¸ì(key)ì— ëŒ€í•œ ë°ì´í„°(value)ë¥¼ ê°€ì ¸ì˜´.
                if let Some(ascii_art) = ascii_map.get(&ch) {
                    line.push_str(ascii_art[row]);
                    line.push_str("  ");
                }
            }
            // ëˆ„ì ëœ ë°ì´í„°ë¥¼ ì¶œë ¥í•¨.
            println!("{}", line);
        }

        // 1ì´ˆ ê¸°ë‹¤ë¦¼
        time::sleep(Duration::from_secs(1)).await;
        total_seconds -= 1;
        seconds_motivation += 1;
    }
}
